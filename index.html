<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>R√°dio Online</title>
<style>
  :root { --spotify-green:#0e692f; --text:#ffffff; }
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    width:100%;height:100vh;overflow:hidden;
    font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,sans-serif;
    color:var(--text);display:flex;align-items:center;justify-content:center;
    background-color:#000;
  }
  .background{
    position:fixed;inset:0;
    background-size:cover;
    background-position:center;
    z-index:-1;
    transition:opacity 0.8s ease-in-out;
  }
  .player-bar{
    position:fixed;bottom:0;left:0;width:100%;
    background:rgba(255,255,255,0.15);
    backdrop-filter:blur(10px) saturate(120%);
    display:flex;flex-direction:column;align-items:center;
    padding:25px 0;gap:15px;
  }
  .play-button{
    width:80px;height:80px;border-radius:50%;border:none;
    background-color:var(--spotify-green);color:#fff;font-size:40px;cursor:pointer;
    display:flex;align-items:center;justify-content:center;
    box-shadow:0 4px 25px rgba(14,105,47,0.4);
    transition:transform .2s ease,box-shadow .2s ease;
  }
  .play-button:hover{transform:scale(1.05);box-shadow:0 6px 28px rgba(14,105,47,0.6);}
  .play-button:active{transform:scale(0.96);}
  .equalizer{display:flex;align-items:flex-end;justify-content:center;height:25px;gap:4px;}
  .bar{width:4px;height:6px;background-color:var(--spotify-green);border-radius:2px;opacity:.8;transform-origin:bottom;}
  .playing .bar{animation:bounce 1s ease-in-out infinite;}
  .playing .bar:nth-child(2){animation-delay:.1s}
  .playing .bar:nth-child(3){animation-delay:.2s}
  .playing .bar:nth-child(4){animation-delay:.3s}
  @keyframes bounce{0%,100%{transform:scaleY(0.3)}50%{transform:scaleY(1.3)}}
  @media(max-width:480px){.play-button{width:70px;height:70px;font-size:30px}}
</style>
</head>
<body>

<div id="bg" class="background"></div>

<div class="player-bar">
  <button id="playPause" class="play-button">‚ñ∂</button>
  <div class="equalizer" id="equalizer">
    <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
  </div>
</div>

<audio id="audio" preload="metadata" src="https://stream.zeno.fm/l8ocj9i6ka2uv"></audio>
<div id="ytContainer" style="display:none;">
  <div id="ytFrame"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getDatabase, ref as dbRef, onValue } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAt4CeGjdbjzdtMH1qZHw6RuBFJ6SeTDKk",
  authDomain: "coletivo-f34d4.firebaseapp.com",
  databaseURL: "https://coletivo-f34d4-default-rtdb.firebaseio.com",
  projectId: "coletivo-f34d4",
  storageBucket: "coletivo-f34d4.firebasestorage.app",
  messagingSenderId: "296376447787",
  appId: "1:296376447787:web:1341c59c8087d6ac1e4b6e"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const infoRef = dbRef(db, "coletivo_info");

const bg = document.getElementById("bg");
const playPauseBtn = document.getElementById("playPause");
const equalizer = document.getElementById("equalizer");
const audio = document.getElementById("audio");
const ytContainer = document.getElementById("ytContainer");

let youtubeAtivo = false;
let ytPlayer = null;
let videoAtual = "";
let usuarioInteragiu = false;

// üîπ Libera som ap√≥s primeiro clique
document.body.addEventListener("click", () => {
  usuarioInteragiu = true;
  if (youtubeAtivo && ytPlayer) ytPlayer.unMute();
}, { once:true });

// üîπ Atualiza√ß√£o din√¢mica via Firebase
onValue(infoRef, (snap) => {
  const info = snap.val() || {};
  if (info.bg) bg.style.backgroundImage = `url('${info.bg}')`;

  if (info.yt && info.yt.includes("youtube.com")) {
    const id = info.yt.split("v=")[1]?.split("&")[0];
    if (id && id !== videoAtual) {
      videoAtual = id;
      tocarYoutube(id);
    }
  } else {
    voltarStreaming();
  }
});

// üîπ Bot√£o play/pause
playPauseBtn.addEventListener("click", async () => {
  if (youtubeAtivo && ytPlayer) {
    const state = ytPlayer.getPlayerState();
    if (state === YT.PlayerState.PLAYING) {
      ytPlayer.pauseVideo();
      playPauseBtn.innerHTML = "‚ñ∂";
      equalizer.classList.remove("playing");
    } else {
      ytPlayer.playVideo();
      ytPlayer.unMute();
      playPauseBtn.innerHTML = "‚ùö‚ùö";
      equalizer.classList.add("playing");
    }
    return;
  }

  // Streaming padr√£o
  if (audio.paused) {
    await audio.play().catch(()=>{});
    playPauseBtn.innerHTML = "‚ùö‚ùö";
    equalizer.classList.add("playing");
  } else {
    audio.pause();
    playPauseBtn.innerHTML = "‚ñ∂";
    equalizer.classList.remove("playing");
  }
});

// üîπ Carrega API do YouTube
function loadYouTubeAPI(videoId) {
  if (window.YT && window.YT.Player) {
    criarPlayer(videoId);
  } else {
    const tag = document.createElement("script");
    tag.src = "https://www.youtube.com/iframe_api";
    document.body.appendChild(tag);
    window.onYouTubeIframeAPIReady = () => criarPlayer(videoId);
  }
}

// üîπ Cria o player YouTube
function criarPlayer(videoId) {
  ytPlayer = new YT.Player("ytFrame", {
    height: "0",
    width: "0",
    videoId,
    playerVars: { autoplay: 1, controls: 0, mute: 1 },
    events: {
      onReady: () => {
        ytPlayer.playVideo();
        playPauseBtn.innerHTML = "‚ùö‚ùö";
        equalizer.classList.add("playing");

        // Som ligado se usu√°rio j√° clicou antes
        if (usuarioInteragiu) ytPlayer.unMute();
      },
      onStateChange: (e) => {
        if (e.data === YT.PlayerState.ENDED) {
          playPauseBtn.innerHTML = "‚ñ∂";
          equalizer.classList.remove("playing");
        }
      }
    }
  });
}

// üîπ Ativa modo YouTube
function tocarYoutube(videoId) {
  youtubeAtivo = true;
  audio.pause();
  ytContainer.style.display = "block";
  if (ytPlayer) ytPlayer.destroy();
  loadYouTubeAPI(videoId);
}

// üîπ Volta ao streaming
function voltarStreaming() {
  if (!youtubeAtivo) return;
  youtubeAtivo = false;
  if (ytPlayer) ytPlayer.destroy();
  ytContainer.style.display = "none";
  audio.play().catch(()=>{});
  playPauseBtn.innerHTML = "‚ùö‚ùö";
  equalizer.classList.add("playing");
}
</script>

</body>
</html>
